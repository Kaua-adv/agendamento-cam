<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <!-- Manter o head existente -->
    <!-- ... -->
</head>
<body>
    <!-- Manter o container e formulário existentes -->
    <!-- ... -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const turmaSelect = document.getElementById('turma');
            const horarioSelect = document.getElementById('horario');
            
            // Gerar todos os horários possíveis
            function gerarTodosHorarios() {
                const horarios = [];
                const startHour = 7;
                const startMinute = 10;
                const endHour = 10;
                const endMinute = 50;
                
                let currentHour = startHour;
                let currentMinute = startMinute;
                
                while (currentHour < endHour || (currentHour === endHour && currentMinute <= endMinute)) {
                    const horaFormatada = currentHour.toString().padStart(2, '0');
                    const minutoFormatado = currentMinute.toString().padStart(2, '0');
                    horarios.push(`${horaFormatada}:${minutoFormatado}`);
                    
                    currentMinute += 10;
                    if (currentMinute >= 60) {
                        currentMinute -= 60;
                        currentHour += 1;
                    }
                }
                
                return horarios;
            }
            
            // Carregar horários ocupados da planilha
            async function carregarHorariosOcupados() {
                try {
                    const response = await fetch('https://script.google.com/macros/s/AKfycbxDqszuYAOMPlatE8roRhm4AKcA5MGQaL3HLJZ8LLJjAQxii50ijrz0C_qkRR-b3gZIKA/exec?action=getHorarios');
                    return await response.json();
                } catch (error) {
                    console.error('Erro ao carregar horários:', error);
                    return {};
                }
            }
            
            // Atualizar os horários disponíveis quando a turma é selecionada
            async function atualizarHorariosDisponiveis() {
                const turmaSelecionada = turmaSelect.value;
                if (!turmaSelecionada) return;
                
                const [todasTurmas, horariosOcupados] = await Promise.all([
                    gerarTodosHorarios(),
                    carregarHorariosOcupados()
                ]);
                
                // Limpar select de horários
                horarioSelect.innerHTML = '<option value="">Selecione um horário...</option>';
                
                // Obter horários ocupados para a turma selecionada
                const ocupadosParaTurma = horariosOcupados[turmaSelecionada] || [];
                
                // Adicionar apenas horários disponíveis
                todasTurmas.forEach(horario => {
                    if (!ocupadosParaTurma.includes(horario)) {
                        const option = document.createElement('option');
                        option.value = horario;
                        option.textContent = horario;
                        horarioSelect.appendChild(option);
                    }
                });
                
                if (horarioSelect.options.length === 1) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'Nenhum horário disponível';
                    option.disabled = true;
                    horarioSelect.appendChild(option);
                }
            }
            
            // Event listener para mudança de turma
            turmaSelect.addEventListener('change', atualizarHorariosDisponiveis);
            
            // Configurar o envio do formulário (manter o existente)
            document.getElementById('agendamentoForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = {
                    responsavel: document.getElementById('responsavel').value,
                    aluno: document.getElementById('aluno').value,
                    turma: document.getElementById('turma').value,
                    horario: document.getElementById('horario').value,
                    data: new Date().toLocaleString()
                };
                
                fetch('SUA_URL_DO_SCRIPT_PUBLICADO/exec', {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                .then(() => {
                    document.getElementById('successMessage').style.display = 'block';
                    document.getElementById('errorMessage').style.display = 'none';
                    document.getElementById('agendamentoForm').reset();
                    setTimeout(() => {
                        document.getElementById('successMessage').style.display = 'none';
                    }, 5000);
                    
                    // Atualizar horários disponíveis após agendamento
                    atualizarHorariosDisponiveis();
                })
                .catch(() => {
                    document.getElementById('errorMessage').style.display = 'block';
                    document.getElementById('successMessage').style.display = 'none';
                    setTimeout(() => {
                        document.getElementById('errorMessage').style.display = 'none';
                    }, 5000);
                });
            });
        });
    </script>
</body>
</html>
